<%- include('../partials/layout-protected-top', { title: 'Orders' }) %>

<div id="root"></div>

<script src="https://unpkg.com/react@17/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

<script type="text/babel">
  const { useState, useEffect } = React;

  function OrdersTable({ orders }) {
    const [sortedOrders, setSortedOrders] = useState(orders);
    const [sortConfig, setSortConfig] = useState({ key: null, direction: 'ascending' });
    const [currentPage, setCurrentPage] = useState(1);
    const [ordersPerPage] = useState(10);

    useEffect(() => {
      setSortedOrders(orders);
    }, [orders]);

    const requestSort = (key) => {
      let direction = 'ascending';
      if (sortConfig.key === key && sortConfig.direction === 'ascending') {
        direction = 'descending';
      }
      setSortConfig({ key, direction });

      setSortedOrders(orders.sort((a, b) => {
        if (a[key] < b[key]) {
          return direction === 'ascending' ? -1 : 1;
        }
        if (a[key] > b[key]) {
          return direction === 'ascending' ? 1 : -1;
        }
        return 0;
      }));
    };

    const indexOfLastOrder = currentPage * ordersPerPage;
    const indexOfFirstOrder = indexOfLastOrder - ordersPerPage;
    const currentOrders = sortedOrders.slice(indexOfFirstOrder, indexOfLastOrder);

    const paginate = (pageNumber) => setCurrentPage(pageNumber);

    return (
      <div>
        <table className="w-full bg-white shadow-md rounded-lg overflow-hidden">
          <thead className="bg-gray-200 text-gray-700">
            <tr>
              <th className="py-3 px-4 text-left cursor-pointer" onClick={() => requestSort('_id')}>Order ID</th>
              <th className="py-3 px-4 text-left cursor-pointer" onClick={() => requestSort('user.email')}>User</th>
              <th className="py-3 px-4 text-left cursor-pointer" onClick={() => requestSort('service.name')}>Service</th>
              <th className="py-3 px-4 text-left cursor-pointer" onClick={() => requestSort('status')}>Status</th>
              <th className="py-3 px-4 text-left cursor-pointer" onClick={() => requestSort('totalAmount')}>Total Amount</th>
              <th className="py-3 px-4 text-left cursor-pointer" onClick={() => requestSort('createdAt')}>Created At</th>
            </tr>
          </thead>
          <tbody>
            {currentOrders.map(order => (
              <tr key={order._id} className="border-b">
                <td className="py-3 px-4">{order._id}</td>
                <td className="py-3 px-4">{order.user ? order.user.email : 'N/A'}</td>
                <td className="py-3 px-4">{order.service ? order.service.name : 'N/A'}</td>
                <td className="py-3 px-4">{order.status}</td>
                <td className="py-3 px-4">${order.totalAmount.toFixed(2)}</td>
                <td className="py-3 px-4">{new Date(order.createdAt).toLocaleString()}</td>
              </tr>
            ))}
          </tbody>
        </table>
        <div className="mt-4 flex justify-center">
          {Array.from({ length: Math.ceil(sortedOrders.length / ordersPerPage) }, (_, i) => (
            <button key={i} onClick={() => paginate(i + 1)} className="mx-1 px-3 py-1 bg-blue-500 text-white rounded">
              {i + 1}
            </button>
          ))}
        </div>
      </div>
    );
  }

  function App() {
    return (
      <div className="container mx-auto px-4 py-8">
        <h1 className="text-3xl font-bold mb-6">Admin Orders</h1>
        <OrdersTable orders={<%- JSON.stringify(orders) %>} />
      </div>
    );
  }

  ReactDOM.render(<App />, document.getElementById('root'));
</script>

<%- include('../partials/layout-public-bottom') %>